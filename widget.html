<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NK Eats - Food Delivery</title>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f5f5f5;
            color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 70px;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            z-index: 1000;
            height: 60px;
        }

        .navbar .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fc8019;
            margin-right: auto;
        }

        .navbar .restaurant-name {
            font-size: 1.2rem;
            font-weight: 500;
            color: #1a1a1a;
            margin-right: auto;
            padding-left: 10px;
            display: none;
        }

        .navbar .cart-button {
            position: relative;
            cursor: pointer;
            background: none;
            border: none;
            color: #000;
            font-size: 1.5rem;
            padding: 5px;
            margin-left: 20px;
        }

        .navbar .cart-button .cart-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #fc8019;
            color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .container {
            width: 100vw;
            padding: 0 20px;
            flex: 1;
            display: flex;
            gap: 20px;
            margin: 0;
        }

        .main-content {
            flex: 2;
            min-width: 0;
            padding: 20px;
        }

        h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .restaurant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .restaurant-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            padding: 20px;
        }

        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .restaurant-card h3 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .restaurant-card p {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 8px;
        }

        .restaurant-card .rating {
            font-size: 0.9rem;
            color: #fff;
            background: #48c479;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 8px;
        }

        .menu-table, .cart-table {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
            display: none;
            margin-bottom: 20px;
            width: 100%;
        }

        .menu-table table, .cart-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .menu-table th, .cart-table th {
            background: #fc8019;
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid #e0e0e0;
        }

        .menu-table td, .cart-table td {
            padding: 15px;
            font-size: 1rem;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }

        .menu-table tr:hover, .cart-table tr:hover {
            background: #fafafa;
        }

        .price-column {
            text-align: right;
            font-weight: 600;
            color: #fc8019;
        }

        .cart-total {
            text-align: right;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fc8019;
        }

        .back-button, .add-to-cart, .confirm-order, .remove-from-cart, .pay-now, .change-address {
            background: linear-gradient(90deg, #fc8019, #e06b00);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 10px 5px;
        }

        .back-button:hover, .add-to-cart:hover, .confirm-order:hover, .remove-from-cart:hover, .pay-now:hover, .change-address:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(252, 128, 25, 0.4);
        }

        .quantity-input {
            width: 60px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            color: #333;
            font-size: 0.9rem;
            text-align: center;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-control button {
            background: #fc8019;
            color: #fff;
            border: none;
            border-radius: 4px;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        .quantity-control button:hover {
            background: #e06b00;
        }

        #orderForm {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        select, input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            color: #333;
            background: #fafafa;
            transition: border-color 0.3s ease;
        }

        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #fc8019;
            box-shadow: 0 0 5px rgba(252, 128, 25, 0.3);
        }

        textarea {
            resize: vertical;
            height: 100px;
        }

        button[type="submit"] {
            background: linear-gradient(90deg, #fc8019, #e06b00);
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(252, 128, 25, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .modal-content p {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-buttons button {
            background: linear-gradient(90deg, #fc8019, #e06b00);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .modal-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(252, 128, 25, 0.4);
        }

        .loading-spinner {
            border: 4px solid #fc8019;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-option {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .payment-option:hover {
            background: #f0f0f0;
        }

        .payment-option.selected {
            background: #e0f7fa;
            border-color: #00bcd4;
        }

        .delivery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .delivery-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .delivery-content p {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
        }

        .delivery-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .delivery-buttons button {
            background: linear-gradient(90deg, #fc8019, #e06b00);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .delivery-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(252, 128, 25, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 0 15px;
            }

            .main-content {
                padding: 10px;
            }

            #orderForm {
                order: 2;
                padding: 15px;
            }

            .restaurant-grid {
                grid-template-columns: 1fr;
            }

            .menu-table, .cart-table {
                max-height: 400px;
            }
        }

        @media (max-width: 480px) {
            h2 {
                font-size: 1.6rem;
            }

            .restaurant-card h3 {
                font-size: 1.2rem;
            }

            .restaurant-card p {
                font-size: 0.9rem;
            }

            .menu-table th, .menu-table td, .cart-table th, .cart-table td {
                font-size: 0.9rem;
                padding: 10px;
            }

            button, .back-button, .add-to-cart, .confirm-order, .remove-from-cart, .pay-now, .change-address {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        .redeem-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .redeem-toggle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ccc;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .redeem-toggle.selected {
            background: #48c479;
            border-color: #48c479;
        }

        .redeem-toggle.selected::after {
            content: "‚úì";
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
        }

        .redeem-toggle.disabled {
            background: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .info-button {
            background: #666;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: #fff;
            margin-left: 10px;
            cursor: pointer;
        }

        .info-tooltip {
            display: none;
            position: absolute;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            max-width: 250px;
            font-size: 0.9rem;
            color: #333;
            white-space: pre-wrap;
        }

        .info-button:hover + .info-tooltip,
        .info-button:focus + .info-tooltip {
            display: block;
        }

        .coin-image {
            width: 16px;
            height: 16px;
            margin-left: 5px;
            object-fit: contain;
        }

        /* New styles for the reward popup */
        .reward-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .reward-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .reward-content img.logo {
            width: 80px;
            height: auto;
            margin-bottom: 15px;
        }

        .reward-content p {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 20px;
        }

        .reward-buttons button {
            background: linear-gradient(90deg, #fc8019, #e06b00);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .reward-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(252, 128, 25, 0.4);
        }

        /* New styles for card details and loader */
        .card-details {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .card-details.show {
            display: flex;
        }

        .card-details .form-group {
            position: relative;
        }

        .card-details .input-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
        }

        .card-details .icon-valid {
            color: #10b981;
            opacity: 0;
        }

        .card-details .icon-invalid {
            color: #ef4444;
            opacity: 0;
        }

        .card-details .input-field.valid + .input-icon .icon-valid {
            opacity: 1;
        }

        .card-details .input-field.invalid + .input-icon .icon-invalid {
            opacity: 1;
        }

        .card-details .form-group.error .label {
            color: #ef4444;
        }

        .card-details .form-group.error .input-field {
            background: rgba(239, 68, 68, 0.2);
        }

        .card-details .form-group.valid .label {
            color: #10b981;
        }

        .card-details .form-group.valid .input-field {
            background: rgba(16, 185, 129, 0.2);
        }

        .order-loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .order-loader.active {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">NK Eats</div>
        <div class="restaurant-name" id="restaurantName"></div>
        <button class="cart-button" id="cartButton">
            üõí
            <span class="cart-counter" id="cartCounter">0</span>
        </button>
    </div>
    <div class="container">
        <div class="main-content">
            <h2>Explore Restaurants</h2>
            <button class="change-address" id="changeAddressButtonRestaurant">Change Address</button>
            <div class="restaurant-grid" id="restaurantGrid">
                <div class="restaurant-card">
                    <div class="loading-spinner"></div>
                    <div class="content">Loading restaurants...</div>
                </div>
            </div>
            <div class="menu-table" id="menuTable">
                <table>
                    <thead>
                        <tr>
                            <th>Dish Name</th>
                            <th>Quantity</th>
                            <th>Type</th>
                            <th class="price-column">Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="menuBody">
                        <tr>
                            <td colspan="5">Select a restaurant to view the menu...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="back-button" id="backButton">Back to Restaurants</button>
                <button class="confirm-order" id="viewCartButton">
                    View Cart
                </button>
            </div>
            <div class="cart-table" id="cartTable">
                <table>
                    <thead>
                        <tr>
                            <th>Dish Name</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="cartBody">
                        <tr>
                            <td colspan="5">Your cart is empty...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="cart-summary">
                    <p>Total Price: ‚Çπ<span id="totalPrice">0.00</span></p>
                    <p>GST (12.5%): ‚Çπ<span id="gstAmount">0.00</span></p>
                    <p>Delivery Charges: ‚Çπ<span id="deliveryCharges">0.00</span></p>
                    <p class="cart-total">Final Price: ‚Çπ<span id="finalPrice">0.00</span></p>
                    <div class="redeem-option">
                        <div class="redeem-toggle" id="redeemToggle"></div>
                        <label>Use NK Coins to Slash Delivery Fees!</label>
                        <img src="https://res.cloudinary.com/daocdfy0k/image/upload/v1752663856/4c58a2b5-ceef-45f0-bf5f-2372bcffd1ea_howqfd.jpg" alt="NK Coin" class="coin-image" id="coinImage">
                        <button class="info-button" id="infoButton">i</button>
                        <div class="info-tooltip" id="infoTooltip">
üçΩÔ∏èüí∞ What Are NK Coins?
NK Coins are your tasty little rewards every time you order with us!
For every ‚Çπ100 you spend on food through the NK Eats app, you earn 1 NK Coin.

Rack up 50 Coins and boom ‚Äî
ü•≥ You unlock Free Delivery on your next order!

So the more you munch, the more you earn.
Start stacking those coins and let your food pay you back üçï‚û°Ô∏èüí∏
                        </div>
                    </div>
                </div>
                <button class="back-button" id="backToMenuButton">Back to Menu</button>
                <button class="confirm-order" id="confirmOrderButton" style="display: none;">Confirm Order</button>
                <button class="change-address" id="changeAddressButton" style="display: none;">Change Address</button>
            </div>
        </div>
        <form id="orderForm" style="flex: 1; min-width: 300px;">
            <div class="form-group">
                <label for="customerDetails">Customer Details</label>
                <textarea id="customerDetails" name="customerDetails" readonly></textarea>
            </div>
            <div class="form-group" id="customAddressGroup" style="display: none;">
                <label for="customAddress">Delivery Address <span style="color: #ef4444;">*</span></label>
                <input type="text" id="customAddress" name="customAddress" placeholder="Enter delivery address" required>
                <label for="customCity" style="margin-top: 15px;">Delivery City <span style="color: #ef4444;">*</span></label>
                <select id="customCity" name="customCity" required>
                    <option value="">Select a City</option>
                    <option value="Ariyalur">Ariyalur</option>
                    <option value="Chengalpattu">Chengalpattu</option>
                    <option value="Chennai">Chennai</option>
                    <option value="Coimbatore">Coimbatore</option>
                    <option value="Cuddalore">Cuddalore</option>
                    <option value="Dharmapuri">Dharmapuri</option>
                    <option value="Dindigul">Dindigul</option>
                    <option value="Erode">Erode</option>
                    <option value="Kallakurichi">Kallakurichi</option>
                    <option value="Kancheepuram">Kancheepuram</option>
                    <option value="Kanyakumari">Kanyakumari</option>
                    <option value="Karur">Karur</option>
                    <option value="Krishnagiri">Krishnagiri</option>
                    <option value="Madurai">Madurai</option>
                    <option value="Mayiladuthurai">Mayiladuthurai</option>
                    <option value="Nagapattinam">Nagapattinam</option>
                    <option value="Namakkal">Namakkal</option>
                    <option value="Nilgiris">Nilgiris</option>
                    <option value="Perambalur">Perambalur</option>
                    <option value="Pudukkottai">Pudukkottai</option>
                    <option value="Ramanathapuram">Ramanathapuram</option>
                    <option value="Ranipet">Ranipet</option>
                    <option value="Salem">Salem</option>
                    <option value="Sivaganga">Sivaganga</option>
                    <option value="Tenkasi">Tenkasi</option>
                    <option value="Thanjavur">Thanjavur</option>
                    <option value="Theni">Theni</option>
                    <option value="Thoothukudi">Thoothukudi</option>
                    <option value="Tiruchirappalli">Tiruchirappalli</option>
                    <option value="Tirunelveli">Tirunelveli</option>
                    <option value="Tirupathur">Tirupathur</option>
                    <option value="Tiruppur">Tiruppur</option>
                    <option value="Tiruvallur">Tiruvallur</option>
                    <option value="Tiruvannamalai">Tiruvannamalai</option>
                    <option value="Tiruvarur">Tiruvarur</option>
                    <option value="Vellore">Vellore</option>
                    <option value="Viluppuram">Viluppuram</option>
                    <option value="Virudhunagar">Virudhunagar</option>
                </select>
            </div>
            <button type="submit" id="createOrderButton">Create Order</button>
        </form>
        <div class="modal" id="addressModal">
            <div class="modal-content">
                <p id="modalAddressText"></p>
                <div class="modal-buttons">
                    <button id="proceedButton">Proceed</button>
                    <button id="addNewAddressButton">Add New Address</button>
                </div>
            </div>
        </div>
        <div class="modal" id="paymentModal">
            <div class="modal-content">
                <h3>Choose Payment Method</h3>
                <div class="payment-options">
                    <div class="payment-option" data-type="Cash">Cash on Delivery</div>
                    <div class="payment-option" data-type="Card">Credit/Debit Card</div>
                    <div class="payment-option" data-type="UPI">UPI</div>
                </div>
                <div class="card-details" id="cardDetails" style="display: none;">
                    <div class="form-group">
                        <label class="label" for="cardNumber">Card Number</label>
                        <div class="input-wrapper">
                            <input type="text" class="input-field" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                            <div class="input-icon"><span class="icon-valid">‚úì</span><span class="icon-invalid">‚úó</span></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label" for="expiryDate">Expiry Date (MM/YY)</label>
                        <div class="input-wrapper">
                            <input type="text" class="input-field" id="expiryDate" placeholder="MM/YY" maxlength="5">
                            <div class="input-icon"><span class="icon-valid">‚úì</span><span class="icon-invalid">‚úó</span></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label" for="cvv">CVV</label>
                        <div class="input-wrapper">
                            <input type="text" class="input-field" id="cvv" placeholder="XXX" maxlength="4">
                            <div class="input-icon"><span class="icon-valid">‚úì</span><span class="icon-invalid">‚úó</span></div>
                        </div>
                    </div>
                </div>
                <div id="payNowButton" style="display: none;">
                    <button class="pay-now">Pay Now</button>
                </div>
                <div class="modal-buttons">
                    <button id="cancelPaymentButton">Cancel</button>
                </div>
            </div>
        </div>
        <div class="delivery-modal" id="deliveryModal">
            <div class="delivery-content">
                <p id="deliveryMessage"></p>
                <div class="loading-spinner" id="deliverySpinner"></div>
                <div class="delivery-buttons" id="deliveryButtons" style="display: none;">
                    <button class="back-button" id="backToOrder">Back</button>
                    <button class="back-button" id="orderAgainButton">Order Again</button>
                </div>
            </div>
        </div>
        <div class="reward-modal" id="rewardModal">
            <div class="reward-content">
                <img src="https://res.cloudinary.com/daocdfy0k/image/upload/v1752663856/4c58a2b5-ceef-45f0-bf5f-2372bcffd1ea_howqfd.jpg" alt="NK Eats Logo" class="logo">
                <p id="rewardMessage"></p>
                <div class="reward-buttons">
                    <button id="closeRewardButton">OK</button>
                </div>
            </div>
        </div>
        <div class="order-loader" id="orderLoader">
            <div class="loading-spinner"></div>
            <p>Processing your new order...</p>
        </div>
    </div>

    <style>
        .cart-summary {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .cart-summary p {
            font-size: 1rem;
            color: #333;
            margin-bottom: 8px;
        }
        .cart-summary p span {
            font-weight: 600;
            color: #fc8019;
        }
    </style>

    <script>
        ZOHO.embeddedApp.on("PageLoad", function (data) {
            ZOHO.CRM.UI.Resize({height:"1000",width:"1500"}).then(function(data){
                console.log(data);
            });

            function fetchRecords(moduleApiName, params = {}) {
                return new Promise((resolve, reject) => {
                    ZOHO.CRM.API.getAllRecords({
                        Entity: moduleApiName,
                        page: 1,
                        per_page: 200,
                        ...params
                    }).then(function(response) {
                        resolve(response.data);
                    }).catch(function(error) {
                        reject(error);
                    });
                });
            }

            let sessionData = data;
            let restaurantRecords = [];
            let customerRecords = [];
            let selectedRestaurantId = null;
            let selectedCustomerCity = null;
            let deliveryAddress = null;
            let useCustomerAddress = true;
            let cart = [];
            let menuItems = [];
            const restaurantGrid = document.getElementById("restaurantGrid");
            const orderForm = document.getElementById("orderForm");
            const menuTable = document.getElementById("menuTable");
            const menuBody = document.getElementById("menuBody");
            const backButton = document.getElementById("backButton");
            const viewCartButton = document.getElementById("viewCartButton");
            const cartCounter = document.getElementById("cartCounter");
            const cartIconCounter = document.getElementById("cartCounter");
            const cartTable = document.getElementById("cartTable");
            const cartBody = document.getElementById("cartBody");
            const backToMenuButton = document.getElementById("backToMenuButton");
            const confirmOrderButton = document.getElementById("confirmOrderButton");
            const changeAddressButtonRestaurant = document.getElementById("changeAddressButtonRestaurant");
            const changeAddressButton = document.getElementById("changeAddressButton");
            const customerDetails = document.getElementById("customerDetails");
            const customAddressGroup = document.getElementById("customAddressGroup");
            const customAddressInput = document.getElementById("customAddress");
            const customCityInput = document.getElementById("customCity");
            const addressModal = document.getElementById("addressModal");
            const modalAddressText = document.getElementById("modalAddressText");
            const proceedButton = document.getElementById("proceedButton");
            const addNewAddressButton = document.getElementById("addNewAddressButton");
            const cartButton = document.getElementById("cartButton");
            const deliveryModal = document.getElementById("deliveryModal");
            const deliveryMessage = document.getElementById("deliveryMessage");
            const deliverySpinner = document.getElementById("deliverySpinner");
            const deliveryButtons = document.getElementById("deliveryButtons");
            const backToOrderButton = document.getElementById("backToOrder");
            const orderAgainButton = document.getElementById("orderAgainButton");
            const paymentModal = document.getElementById("paymentModal");
            const paymentOptions = document.querySelectorAll(".payment-option");
            const cardDetails = document.getElementById("cardDetails");
            const cardNumber = document.getElementById("cardNumber");
            const expiryDate = document.getElementById("expiryDate");
            const cvv = document.getElementById("cvv");
            const payNowButton = document.getElementById("payNowButton");
            const cancelPaymentButton = document.getElementById("cancelPaymentButton");
            const totalPriceElement = document.getElementById("totalPrice");
            const gstAmountElement = document.getElementById("gstAmount");
            const deliveryChargesElement = document.getElementById("deliveryCharges");
            const finalPriceElement = document.getElementById("finalPrice");
            const redeemToggle = document.getElementById("redeemToggle");
            const infoButton = document.getElementById("infoButton");
            const infoTooltip = document.getElementById("infoTooltip");
            const coinImage = document.getElementById("coinImage");
            const rewardModal = document.getElementById("rewardModal");
            const rewardMessage = document.getElementById("rewardMessage");
            const closeRewardButton = document.getElementById("closeRewardButton");
            const restaurantName = document.getElementById("restaurantName");
            const orderLoader = document.getElementById("orderLoader");
            let selectedPaymentType = null;
            let customerId = data.EntityId[0]; // Use the specific ID from the array
            let customerPoints = 0;
            let isRedeemSelected = false;

            function showAddressModal(address, city) {
                modalAddressText.textContent = `Deliver to this address?\n${address || 'No address provided'}\nCity: ${city || 'N/A'}`;
                addressModal.style.display = "flex";
                return new Promise((resolve) => {
                    proceedButton.onclick = () => {
                        addressModal.style.display = "none";
                        resolve(true);
                    };
                    addNewAddressButton.onclick = () => {
                        addressModal.style.display = "none";
                        customAddressGroup.style.display = 'block';
                        resolve(false);
                    };
                });
            }

            function validateCustomAddress() {
                const address = customAddressInput.value.trim();
                const city = customCityInput.value;
                if (!address || !city) {
                    alert("Both Delivery Address and Delivery City are required.");
                    return false;
                }
                deliveryAddress = address;
                selectedCustomerCity = city;
                useCustomerAddress = false;
                customAddressGroup.style.display = 'none';
                populateRestaurants(selectedCustomerCity); // Update restaurant list with new city
                return true;
            }

            function updateCartDisplay() {
                const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCounter.textContent = itemCount;
                cartIconCounter.textContent = itemCount;
                if (cart.length === 0) {
                    cartBody.innerHTML = `<tr><td colspan="5">Your cart is empty...</td></tr>`;
                    totalPriceElement.textContent = "0.00";
                    gstAmountElement.textContent = "0.00";
                    deliveryChargesElement.textContent = "0.00";
                    finalPriceElement.textContent = "0.00";
                    confirmOrderButton.style.display = "none";
                    changeAddressButton.style.display = "none";
                    viewCartButton.textContent = "View Cart";
                    redeemToggle.classList.remove("selected", "disabled");
                    isRedeemSelected = false;
                } else {
                    let total = 0;
                    cartBody.innerHTML = cart.map((item, index) => {
                        const itemTotal = item.quantity * item.price;
                        total += itemTotal;
                        return `
                            <tr>
                                <td>${item.dishName}</td>
                                <td>
                                    <div class="quantity-control">
                                        <button class="decrease-quantity" data-index="${index}">-</button>
                                        <span class="quantity-value">${item.quantity}</span>
                                        <button class="increase-quantity" data-index="${index}">+</button>
                                    </div>
                                </td>
                                <td>‚Çπ${parseFloat(item.price).toFixed(2)}</td>
                                <td class="price-column">‚Çπ${itemTotal.toFixed(2)}</td>
                                <td><button class="remove-from-cart" data-index="${index}">Remove</button></td>
                            </tr>
                        `;
                    }).join("");
                    const totalPrice = total.toFixed(2);
                    const gstAmount = (total * 0.125).toFixed(2); // 12.5% GST
                    let deliveryCharges = total < 1000 ? 50.00 : 70.00;
                    if (isRedeemSelected && customerPoints >= 50) {
                        deliveryCharges = 0.00;
                    }
                    const finalPrice = (parseFloat(totalPrice) + parseFloat(gstAmount) + deliveryCharges).toFixed(2);
                    totalPriceElement.textContent = totalPrice;
                    gstAmountElement.textContent = gstAmount;
                    deliveryChargesElement.textContent = deliveryCharges.toFixed(2);
                    finalPriceElement.textContent = finalPrice;
                    confirmOrderButton.style.display = "block";
                    changeAddressButton.style.display = "block";
                    viewCartButton.textContent = `View Cart`;
                    redeemToggle.classList.toggle("disabled", customerPoints < 50);
                    if (customerPoints < 50) {
                        redeemToggle.classList.remove("selected");
                        isRedeemSelected = false;
                    }

                    // Add event listeners for quantity controls
                    document.querySelectorAll(".increase-quantity").forEach(button => {
                        button.addEventListener("click", function() {
                            const index = parseInt(this.dataset.index);
                            cart[index].quantity += 1;
                            updateCartDisplay();
                        });
                    });
                    document.querySelectorAll(".decrease-quantity").forEach(button => {
                        button.addEventListener("click", function() {
                            const index = parseInt(this.dataset.index);
                            if (cart[index].quantity > 1) {
                                cart[index].quantity -= 1;
                                updateCartDisplay();
                            }
                        });
                    });
                }
            }

            function populateRestaurants(city = null) {
                restaurantGrid.innerHTML = '<div class="restaurant-card"><div class="loading-spinner"></div><div class="content">Loading restaurants...</div></div>';
                fetchRecords("Restaurants", { fields: "Restaurant_Name,Status,City,Ratings,No_of_Reviews" })
                    .then(function(restaurants) {
                        restaurantRecords = restaurants;
                        let filteredRestaurants = restaurants.filter(record => record.Status === "Open");
                        if (city) {
                            filteredRestaurants = filteredRestaurants.filter(record => record.City === city);
                        }
                        restaurantGrid.innerHTML = '';
                        if (filteredRestaurants.length === 0) {
                            restaurantGrid.innerHTML = '<div class="restaurant-card"><div class="content">No restaurants available in your city</div></div>';
                        } else {
                            filteredRestaurants.forEach(record => {
                                const card = document.createElement("div");
                                card.className = "restaurant-card";
                                card.dataset.id = record.id;
                                card.setAttribute("role", "button");
                                card.setAttribute("tabindex", "0");
                                card.setAttribute("aria-label", `Select restaurant: ${record.Restaurant_Name}`);
                                card.innerHTML = `
                                    <div class="content">
                                        <h3>${record.Restaurant_Name || record.name || "Unnamed Restaurant"}</h3>
                                        <p>Status: ${record.Status || "N/A"}</p>
                                        <p>City: ${record.City || "N/A"}</p>
                                        <p class="rating">‚òÖ ${record.Ratings ? parseFloat(record.Ratings).toFixed(1) : "N/A"} (${record.No_of_Reviews || 0} reviews)</p>
                                    </div>
                                `;
                                card.addEventListener("click", () => {
                                    selectedRestaurantId = record.id;
                                    cart = [];
                                    updateCartDisplay();
                                    ZOHO.CRM.API.getRecord({
                                        Entity: "Restaurants",
                                        RecordID: record.id
                                    }).then(function(response) {
                                        menuItems = response.data[0].Menu || [];
                                        if (menuItems.length) {
                                            menuBody.innerHTML = menuItems.map((item, index) => `
                                                <tr>
                                                    <td>${item.Dish_Name || "N/A"}</td>
                                                    <td><input type="number" min="1" value="1" class="quantity-input" data-index="${index}"></td>
                                                    <td>${item.Type || "N/A"}</td>
                                                    <td class="price-column">‚Çπ${item.Price ? parseFloat(item.Price).toFixed(2) : "N/A"}</td>
                                                    <td><button class="add-to-cart" data-index="${index}">Add to Cart</button></td>
                                                </tr>
                                            `).join("");
                                            viewCartButton.style.display = "block";
                                        } else {
                                            menuBody.innerHTML = `
                                                <tr>
                                                    <td colspan="5">No menu items found for this restaurant.</td>
                                                </tr>
                                            `;
                                            viewCartButton.style.display = "none";
                                        }
                                        restaurantGrid.style.display = "none";
                                        orderForm.style.display = "block";
                                        menuTable.style.display = "block";
                                        backButton.style.display = "block";
                                        restaurantName.textContent = response.data[0].Restaurant_Name || "Selected Restaurant";
                                        restaurantName.style.display = "block";
                                    }).catch(function(error) {
                                        alert("Failed to load menu: " + (error.message || "Unknown error"));
                                    });
                                    document.querySelectorAll(".restaurant-card").forEach(c => c.style.backgroundColor = "");
                                    card.style.backgroundColor = "#fff3e6";
                                });
                                restaurantGrid.appendChild(card);
                            });
                        }
                    })
                    .catch(function(error) {
                        restaurantGrid.innerHTML = '<div class="restaurant-card"><div class="content">Error loading restaurants</div></div>';
                    });
            }

            // Fetch the specific customer record using EntityId
            ZOHO.CRM.API.getRecord({
                Entity: "Customers",
                RecordID: customerId
            }).then(function(response) {
                customerRecords = response.data;
                const customer = customerRecords[0];
                if (customer) {
                    const details = `Name: ${customer.Full_Name || customer.name || 'N/A'}\nEmail: ${customer.Email || 'N/A'}\nPhone: ${customer.Contact_No || 'N/A'}\nAddress: ${customer.Address || 'N/A'}\nCity: ${customer.City || 'N/A'}\nNK_coins: ${customer.Points || 0}`;
                    customerDetails.value = details;
                    deliveryAddress = customer.Address || '';
                    selectedCustomerCity = customer.City || null;
                    useCustomerAddress = true;
                    customerPoints = parseInt(customer.Points) || 0;
                    showAddressModal(customer.Address, customer.City).then(confirmAddress => {
                        if (!confirmAddress) {
                            customAddressGroup.style.display = 'block';
                        } else {
                            customAddressGroup.style.display = 'none';
                            populateRestaurants(selectedCustomerCity);
                        }
                        updateCartDisplay();
                    });
                } else {
                    customerDetails.value = 'Customer not found';
                    customAddressGroup.style.display = 'none';
                    selectedCustomerCity = null;
                    deliveryAddress = null;
                    useCustomerAddress = true;
                    customerPoints = 0;
                    populateRestaurants();
                    updateCartDisplay();
                }
            }).catch(function(error) {
                customerDetails.value = 'Error loading customer details: ' + (error.message || 'Unknown error');
                customAddressGroup.style.display = 'none';
                selectedCustomerCity = null;
                deliveryAddress = null;
                useCustomerAddress = true;
                customerPoints = 0;
                populateRestaurants();
                updateCartDisplay();
            });

            customCityInput.addEventListener("change", function() {
                selectedCustomerCity = this.value || null;
                populateRestaurants(selectedCustomerCity); // Update restaurants when city changes
            });

            customAddressInput.addEventListener("input", function() {
                deliveryAddress = this.value.trim() || '';
            });

            orderForm.addEventListener("submit", function(e) {
                e.preventDefault();
                if (customAddressGroup.style.display === 'block' && !validateCustomAddress()) {
                    return;
                }
                if (cart.length > 0) {
                    cartTable.style.display = "block";
                    menuTable.style.display = "none";
                    restaurantGrid.style.display = "none";
                    orderForm.style.display = "block";
                    backButton.style.display = "none";
                    updateCartDisplay();
                } else {
                    alert("Please add items to your cart before creating an order.");
                }
            });

            menuTable.addEventListener("click", function(e) {
                if (e.target.classList.contains("add-to-cart")) {
                    const index = e.target.dataset.index;
                    const item = menuItems[index];
                    const quantityInput = document.querySelector(`.quantity-input[data-index="${index}"]`);
                    const quantity = parseInt(quantityInput.value) || 1;
                    if (item && item.Price && quantity > 0) {
                        const existingItem = cart.find(cartItem => cartItem.dishName === item.Dish_Name);
                        if (existingItem) {
                            existingItem.quantity += quantity;
                        } else {
                            cart.push({
                                dishName: item.Dish_Name,
                                quantity: quantity,
                                price: parseFloat(item.Price),
                                type: item.type || "N/A"
                            });
                        }
                        updateCartDisplay();
                    }
                }
            });

            cartTable.addEventListener("click", function(e) {
                if (e.target.classList.contains("remove-from-cart")) {
                    const index = parseInt(e.target.dataset.index);
                    cart.splice(index, 1);
                    updateCartDisplay();
                }
            });

            viewCartButton.addEventListener("click", function() {
                menuTable.style.display = "none";
                cartTable.style.display = "block";
                backButton.style.display = "none";
            });

            backToMenuButton.addEventListener("click", function() {
                cartTable.style.display = "none";
                menuTable.style.display = "block";
                backButton.style.display = "block";
                viewCartButton.style.display = "block";
            });

            confirmOrderButton.addEventListener("click", function() {
                if (cart.length === 0) {
                    alert("Your cart is empty. Please add items before confirming the order.");
                    return;
                }
                if (!customerId) {
                    alert("Customer data not available.");
                    return;
                }
                if (!selectedRestaurantId) {
                    alert("Please select a restaurant.");
                    return;
                }
                if (!deliveryAddress) {
                    alert("Please provide a delivery address.");
                    return;
                }
                paymentModal.style.display = "flex";
            });

            backButton.addEventListener("click", function() {
                restaurantGrid.style.display = "grid";
                orderForm.style.display = "block";
                menuTable.style.display = "none";
                cartTable.style.display = "none";
                backButton.style.display = "none";
                viewCartButton.style.display = "none";
                selectedRestaurantId = null;
                cart = [];
                restaurantName.style.display = "none";
                updateCartDisplay();
                populateRestaurants(selectedCustomerCity);
            });

            cartButton.addEventListener("click", function() {
                if (selectedRestaurantId && cart.length > 0) {
                    menuTable.style.display = "none";
                    cartTable.style.display = "block";
                    backButton.style.display = "none";
                    viewCartButton.style.display = "none";
                    updateCartDisplay();
                } else if (selectedRestaurantId && cart.length === 0) {
                    alert("Your cart is empty. Please add items before viewing.");
                } else {
                    alert("Please select a restaurant first.");
                }
            });

            backToOrderButton.addEventListener("click", function() {
                deliveryModal.style.display = "none";
                restaurantGrid.style.display = "grid";
                orderForm.style.display = "block";
                menuTable.style.display = "none";
                cartTable.style.display = "none";
                backButton.style.display = "none";
                viewCartButton.style.display = "none";
                selectedRestaurantId = null;
                cart = [];
                customerDetails.value = '';
                customAddressGroup.style.display = 'none';
                restaurantName.style.display = "none";
                updateCartDisplay();
                populateRestaurants();
            });

            changeAddressButtonRestaurant.addEventListener("click", function() {
                customAddressGroup.style.display = 'block';
                showAddressModal(deliveryAddress, selectedCustomerCity).then(confirmAddress => {
                    if (!confirmAddress) {
                        customAddressGroup.style.display = 'block';
                    } else if (validateCustomAddress()) {
                        customAddressGroup.style.display = 'none';
                    }
                });
            });

            changeAddressButton.addEventListener("click", function() {
                customAddressGroup.style.display = 'block';
                showAddressModal(deliveryAddress, selectedCustomerCity).then(confirmAddress => {
                    if (!confirmAddress) {
                        customAddressGroup.style.display = 'block';
                    } else if (validateCustomAddress()) {
                        customAddressGroup.style.display = 'none';
                        updateCartDisplay();
                    }
                });
            });

            paymentOptions.forEach(option => {
                option.addEventListener("click", function() {
                    paymentOptions.forEach(opt => opt.classList.remove("selected"));
                    this.classList.add("selected");
                    selectedPaymentType = this.getAttribute("data-type");
                    cardDetails.style.display = "none";
                    payNowButton.style.display = "none";
                    if (selectedPaymentType === "Card") {
                        cardDetails.style.display = "flex";
                        payNowButton.style.display = "block";
                    } else {
                        payNowButton.style.display = "block";
                    }
                });
            });

            cancelPaymentButton.addEventListener("click", function() {
                paymentModal.style.display = "none";
                selectedPaymentType = null;
                cardDetails.style.display = "none";
                payNowButton.style.display = "none";
                paymentOptions.forEach(opt => opt.classList.remove("selected"));
            });

            document.querySelector(".pay-now").addEventListener("click", function() {
                if (selectedPaymentType === "Card") {
                    if (validateCardDetails()) {
                        createOrder();
                        paymentModal.style.display = "none";
                    } else {
                        alert("Please enter valid card details.");
                    }
                } else if (selectedPaymentType) {
                    createOrder();
                    paymentModal.style.display = "none";
                } else {
                    alert("Please select a payment method.");
                }
            });

            function validateCardDetails() {
                const cardNum = cardNumber.value.replace(/\s/g, '');
                const expiry = expiryDate.value;
                const cvvVal = cvv.value;
                const isCardValid = /^\d{16}$/.test(cardNum);
                const isExpiryValid = /^(0[1-9]|1[0-2])\/[0-9]{2}$/.test(expiry) && isFutureDate(expiry);
                const isCvvValid = /^\d{3,4}$/.test(cvvVal);
                cardNumber.classList.toggle("valid", isCardValid);
                cardNumber.classList.toggle("invalid", !isCardValid);
                expiryDate.classList.toggle("valid", isExpiryValid);
                expiryDate.classList.toggle("invalid", !isExpiryValid);
                cvv.classList.toggle("valid", isCvvValid);
                cvv.classList.toggle("invalid", !isCvvValid);
                return isCardValid && isExpiryValid && isCvvValid;
            }

            function isFutureDate(expiry) {
                const [month, year] = expiry.split('/').map(Number);
                const now = new Date();
                const currentYear = now.getFullYear() % 100;
                const currentMonth = now.getMonth() + 1;
                return year > currentYear || (year === currentYear && month >= currentMonth);
            }

            cardNumber.addEventListener("input", function() {
                this.value = this.value.replace(/\D/g, '').replace(/(\d{4})/g, '$1 ').trim().slice(0, 19);
                validateCardDetails();
            });

            expiryDate.addEventListener("input", function() {
                this.value = this.value.replace(/\D/g, '').replace(/(\d{2})/, '$1/').replace(/\/$/, '').slice(0, 5);
                validateCardDetails();
            });

            cvv.addEventListener("input", function() {
                this.value = this.value.replace(/\D/g, '').slice(0, 4);
                validateCardDetails();
            });

            redeemToggle.addEventListener("click", function() {
                if (!this.classList.contains("disabled")) {
                    isRedeemSelected = !isRedeemSelected;
                    this.classList.toggle("selected", isRedeemSelected);
                    updateCartDisplay();
                }
            });

            function createOrder() {
                const selectedRestaurant = restaurantRecords.find(record => record.id === selectedRestaurantId);
                const selectedCustomer = customerRecords.find(record => record.id === customerId);
                const total = cart.reduce((sum, item) => sum + item.quantity * item.price, 0);
                const totalPrice = total.toFixed(2);
                const gstAmount = (total * 0.125).toFixed(2); // 12.5% GST
                let deliveryCharges = total < 1000 ? 50.00 : 70.00;
                if (isRedeemSelected && customerPoints >= 50) {
                    deliveryCharges = 0.00;
                }
                const finalPrice = (parseFloat(totalPrice) + parseFloat(gstAmount) + deliveryCharges).toFixed(2);
                const orderItems = cart.map(item => ({
                    Dish_Name: item.dishName,
                    Price: (item.price * item.quantity).toString(),
                    Quantity: item.quantity,
                    Type: item.type
                }));
                const paymentStatus = selectedPaymentType === "Cash" ? "Pending" : "Paid";
                const redeemPoints = isRedeemSelected && customerPoints >= 50;
                const orderData = {
                    Restaurant: { id: selectedRestaurantId },
                    Customer_Name: { id: customerId },
                    Delivery_Address: useCustomerAddress ? (selectedCustomer.Address || '') : deliveryAddress,
                    Delivery_City: useCustomerAddress ? (selectedCustomer.City || '') : selectedCustomerCity || '',
                    Total_Price: totalPrice,
                    Delivery_Charges: deliveryCharges.toString(),
                    GST_amount: gstAmount,
                    Final_Price: finalPrice,
                    Ordered_Item: orderItems,
                    Payment_Type: selectedPaymentType,
                    Payment_Status: paymentStatus,
                    Redeem_Points: redeemPoints,
                    Session_ID: sessionData.EntityId[0] || sessionData.Entity || "N/A",
                    Session_User: sessionData.User?.id || "N/A"
                };
                ZOHO.CRM.API.insertRecord({
                    Entity: "Orders",
                    APIData: orderData
                }).then(function(response) {
                    if (response.data && response.data[0].code === "SUCCESS") {
                        const orderId = response.data[0].details.id;
                        alert("Order created successfully! ID: " + orderId);
                        deliveryModal.style.display = "flex";
                        deliverySpinner.style.display = "block";
                        deliveryMessage.textContent = "Assigning delivery partner...";

                        // Show reward popup after payment
                        const savedAmount = isRedeemSelected && customerPoints >= 50 ? (total < 1000 ? 50.00 : 70.00) : 0;
                        const earnedCoins = isRedeemSelected ? 0 : Math.floor(total / 100);
                        if (savedAmount > 0) {
                            rewardMessage.textContent = `You saved ‚Çπ${savedAmount.toFixed(2)} using NK Coins!`;
                        } else if (earnedCoins > 0) {
                            rewardMessage.textContent = `You earned ${earnedCoins} NK Coins!`;
                        } else {
                            rewardMessage.textContent = `You earned 0 NK Coins!`;
                        }
                        rewardModal.style.display = "flex";

                        ZOHO.CRM.API.getRecord({
                            Entity: "Orders",
                            RecordID: orderId
                        }).then(function(orderResponse) {
                            const deliveryPartnerId = orderResponse.data[0].Delivery_partner_info?.id;
                            if (deliveryPartnerId) {
                                setTimeout(() => {
                                    ZOHO.CRM.API.getRecord({
                                        Entity: "Delivery_Partners",
                                        RecordID: deliveryPartnerId
                                    }).then(function(partnerResponse) {
                                        const partner = partnerResponse.data[0];
                                        const partnerName = partner.Partner_Name || "Unknown Partner";
                                        const contactNumber = partner.Contact_Number || "N/A";
                                        deliverySpinner.style.display = "none";
                                        deliveryMessage.textContent = `Your order is on the way to be picked up!\nDelivery Partner: ${partnerName}\nContact: ${contactNumber}`;
                                        deliveryButtons.style.display = "flex";
                                    }).catch(function(error) {
                                        console.error("Error fetching partner details:", error);
                                        deliverySpinner.style.display = "none";
                                        deliveryMessage.textContent = "Failed to fetch delivery partner details. Please contact support.";
                                        deliveryButtons.style.display = "flex";
                                    });
                                }, 10000);
                            } else {
                                deliverySpinner.style.display = "none";
                                deliveryMessage.textContent = "No delivery partner assigned yet.";
                                deliveryButtons.style.display = "flex";
                            }
                        }).catch(function(error) {
                            console.error("Error fetching order details:", error);
                            deliverySpinner.style.display = "none";
                            deliveryMessage.textContent = "Failed to retrieve order details.";
                            deliveryButtons.style.display = "flex";
                        });
                    } else {
                        const errorMessage = response.data && response.data[0].message
                            ? response.data[0].message
                            : "Unknown error occurred.";
                        alert(`Order creation failed: ${errorMessage}`);
                    }
                }).catch(function(error) {
                    alert("Failed to create order: " + (error.message || "Unknown error"));
                });
            }

            closeRewardButton.addEventListener("click", function() {
                rewardModal.style.display = "none";
            });

            orderAgainButton.addEventListener("click", function() {
                orderLoader.classList.add("active");
                setTimeout(() => {
                    location.reload();
                }, 5000); // 5-second buffer with loader
            });

            populateRestaurants(selectedCustomerCity);
        });

        ZOHO.embeddedApp.init();
    </script>